"use strict";$(document).ready(function(){setTimeout(getData,500);});const factory=[{"constant":false,"inputs":[{"name":"squirrel","type":"address"}],"name":"createStash","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"stashAddress","type":"address"},{"name":"startIndex","type":"uint256"},{"name":"amount","type":"uint256"}],"name":"getLatestHistory","outputs":[{"name":"","type":"address[]"},{"name":"","type":"address[]"},{"name":"","type":"uint256[8][]"},{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"stashAddress","type":"address"},{"name":"startIndex","type":"uint256"},{"name":"endIndex","type":"uint256"}],"name":"getAdmins","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"stashAddress","type":"address"},{"name":"startIndex","type":"uint256"},{"name":"endIndex","type":"uint256"}],"name":"getWhitelisted","outputs":[{"name":"","type":"address[]"},{"name":"","type":"bool[2][]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"startIndex","type":"uint256"},{"name":"endIndex","type":"uint256"}],"name":"getSquirrels","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"stashes","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}];const erc20=[{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"from","type":"address"},{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transferFrom","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"to","type":"address"},{"name":"tokens","type":"uint256"}],"name":"transfer","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"spender","type":"address"},{"name":"tokens","type":"uint256"},{"name":"data","type":"bytes"}],"name":"approveAndCall","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"tokenOwner","type":"address"},{"name":"spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"name":"from","type":"address"},{"indexed":true,"name":"to","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"tokenOwner","type":"address"},{"indexed":true,"name":"spender","type":"address"},{"indexed":false,"name":"tokens","type":"uint256"}],"name":"Approval","type":"event"}];const oldFactoryAddress="0x6975e716a1e3b643e51bc5efa9cbe0f501b4b871";const factoryAddress="0x40f59f9dfa4167ecf45c7c296fac0919984d8e80";var stashAddress;var oldStashAddress;var web3;var factoryContract;var oldFactoryContract;var stashContract;var account;function getData(){if(typeof window.ethereum!=='undefined'){window.ethereum.enable();web3=new Web3(window.ethereum);oldFactoryContract=web3.eth.contract(factory).at(oldFactoryAddress);factoryContract=web3.eth.contract(factory).at(factoryAddress);checkAccount();}else if(web3){oldFactoryContract=web3.eth.contract(factory).at(oldFactoryAddress);factoryContract=web3.eth.contract(factory).at(factoryAddress);checkAccount();}}
var assets=0;function checkAccount(){if(web3&&web3.eth){web3.eth.getAccounts((err,accounts)=>{if(accounts==null||accounts.length==0){console.log("NO ACCOUNT CONNECTED");}else{if(account!=accounts[0]){account=accounts[0];oldFactoryContract._eth.defaultAccount=account;factoryContract._eth.defaultAccount=account;}
if(account!=null){factoryContract.stashes(account,(err,result)=>{stashAddress=result;if(stashAddress=="0x"||stashAddress=="0x0000000000000000000000000000000000000000"){$("#createStash").text("Create Stash").fadeTo(50,1).removeAttr('onclick').off('click').click(createStash);$("#viewStash").text("No Stash Found").fadeTo(50,0.4).removeAttr('onclick').off('click');}else{$("#createStash").text("Stash Already Exists").fadeTo(50,0.4).removeAttr('onclick').off('click');$("#viewStash").text("View Your Stash").fadeTo(50,1).removeAttr('onclick').off('click').click(viewStash);}});oldFactoryContract.stashes(account,(err,result)=>{oldStashAddress=result;if(oldStashAddress!="0x"&&oldStashAddress!="0x0000000000000000000000000000000000000000"){$("#viewOldStash").text("View Your Stash").fadeTo(50,1).removeAttr('onclick').off('click').click(viewOldStash);$("#oldStash").show();}});}}});}
if(assets==0){const nuts=web3.eth.contract(erc20).at("0x84294FC9710e1252d407d3D80A84bC39001bd4A8");const usdc=web3.eth.contract(erc20).at("0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48");const dai=web3.eth.contract(erc20).at("0x6b175474e89094c44da98b954eedeac495271d0f");var numStashes=0;var numOldStashes=0;factoryContract.getSquirrels(0,0,(err,result)=>{const stashes=result.length;for(var i=0;i<stashes;i++){const player=result[i];var responses=0;factoryContract.stashes(player,(err,result)=>{web3.eth.getBalance(result,function(error,result){assets+=web3.fromWei(result,"ether")*1500;responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});usdc.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"mwei"));responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});dai.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"ether"));responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});nuts.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"ether")*3);responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});});}
numStashes=result.length;$("#totalStashes").text((numStashes+numOldStashes)+" Users");});oldFactoryContract.getSquirrels(0,0,(err,result)=>{const stashes=result.length;for(var i=0;i<stashes;i++){const player=result[i];var responses=0;oldFactoryContract.stashes(player,(err,result)=>{web3.eth.getBalance(result,function(error,result){assets+=web3.fromWei(result,"ether")*500;responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});usdc.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"mwei"));responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});dai.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"ether"));responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});nuts.balanceOf(result,(err,result)=>{assets+=new Number(web3.fromWei(result,"ether"));responses++;if(responses==stashes*4){$("#totalValue").text("$"+Math.floor(assets));}});});}
numOldStashes=result.length;$("#totalStashes").text((numStashes+numOldStashes)+" Users");});}
setTimeout(checkAccount,1000);}
function connectAccount(){if(window.ethereum){window.ethereum.enable();}}
function createStash(){if(account==null){return console.log("NO ACCOUNT CONNECTED - REFRESH METAMASK");}
factoryContract.createStash(account,{gas:2800000},function(error,result){console.log(result);});}
function viewStash(){if(stashAddress!=null&&stashAddress.length==42){window.location="https://squirrel.finance/stash.html?&id="+stashAddress;}}
function viewOldStash(){if(oldStashAddress!=null&&oldStashAddress.length==42){window.location="https://squirrel.finance/stash.html?&id="+oldStashAddress;}}
function accessStash(){const stash=$("#stashAddress").val();if(stash.length==42){window.location="https://squirrel.finance/stash.html?&id="+stash;}}